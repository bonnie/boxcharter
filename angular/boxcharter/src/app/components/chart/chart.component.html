<!--
  Copyright (c) 2017 Bonnie Schulkin. All Rights Reserved.

  This file is part of BoxCharter.

  BoxCharter is free software: you can redistribute it and/or modify it under
  the terms of the GNU Affero General Public License as published by the Free
  Software Foundation, either version 3 of the License, or (at your option)
  any later version.

  BoxCharter is distributed in the hope that it will be useful, but WITHOUT
  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License
  for more details.

  You should have received a copy of the GNU Affero General Public License
  along with BoxCharter. If not, see <http://www.gnu.org/licenses/>.
-->

<app-user-charts *ngIf="!chart"></app-user-charts>

<div *ngIf="chart" (click)="statusService.clearSuccess()" (change)="dirty=true" >
  <div class="chart-metadata">
    <!-- START: chart buttons -->
    <div class="chart-btn-group page-header">
      <button class="btn btn-primary-outline" (click)="saveChart()">
        Save
      </button>
      <button class="btn btn-warning-outline" (click)="revertConfirm=true">
        Revert
      </button>
      <button class="btn btn-danger-outline" (click)="deleteConfirm=true;deleteType='chart'">
        Delete
      </button>
      <div class="dropdown">
        <button class="dropdown-toggle btn btn-link" type="button">
            Switch chart
            <clr-icon shape="caret down"></clr-icon>
        </button>
        <div class="dropdown-menu">
          <a *ngFor="let chart of authService.currentUser.charts" (click)=chartService.loadChart(chart.chartId) class="dropdown-item">
            {{ chart.title }}
          </a>
          <div class="dropdown-divider"></div>
          <a href="..." class="dropdown-item">New chart</a>
        </div>
      </div>
    </div>
    <!-- END: chart buttons -->

    <div class="chart-metadata">
    <input id="chart-title"
          class="title boxchart" 
          type="text" 
          size="64"
          placeholder="chart title"
          [(ngModel)]="chart.title">
        
    <!-- START: chart metadata tree -->
    <clr-tree-node class="chart-metadata" [clrTreeNodeExpanded]="expandChartData['authors']">
      Chart Authors
      <clr-tree-node class="form-group chart-md">
        <label class="chart-md chart-author" for="chart-composer">Music by</label>
        <input id="chart-composer"
            class="chart-md boxchart"
            type="text"
            size="48"
            placeholder="composer"
            [(ngModel)]="chart.composer">
      </clr-tree-node>
      <clr-tree-node class="form-group chart-md">
        <label class="chart-md chart-author" for="chart-lyricist">Lyrics by (</label>
        <input id="chart-lyricist-same" 
            type="checkbox" 
            [(ngModel)]="chart.lyricistSame">
          <label class="chart-md" for="chart-lyricist-same">Same as composer )</label>
        <span *ngIf="chart.lyricistSame == false">
          <input id="chart-lyricist"
              class="chart-md boxchart"
              type="text"
              size="48"
              placeholder="chart lyricist"
              [(ngModel)]="chart.lyricist">
        </span>
      </clr-tree-node>
      <clr-tree-node class="form-group chart-md">
        <label class="chart-md chart-author" for="chart-author">Chart by</label>
          <input id="chart-author"
            class="chart-md boxchart"
            type="text"
            size="48"
            placeholder="chart author"
            [(ngModel)]="chart.author">
      </clr-tree-node>
    </clr-tree-node>
    <clr-tree-node [clrTreeNodeExpanded]="expandChartData['keys']">
      Chart Keys
      <clr-tree-node class="form-group chart-md">
        <label class="chart-md" for="original-key">Original Key</label>
        <input id="original-key"
            class="chart-md boxchart"
            type="text"
            size="4"
            [(ngModel)]="chart.originalKey">
      </clr-tree-node>
      <clr-tree-node class="form-group chart-md">
        <label class="chart-md" for="transposed-key">Transposed Key</label>
        <input id="transposed-key"
            class="chart-md boxchart"
            type="text"
            size="4"
            [(ngModel)]="chart.printKey">
      </clr-tree-node>
    </clr-tree-node>
    <clr-tree-node [clrTreeNodeExpanded]="expandChartData['pdf']">
      Chart PDF Options
      <clr-tree-node class="form-group chart-md">
        <label class="chart-md" for="max-pages">Maximum chart pages</label>
        <input id="max-pages"
            class="chart-md boxchart"
            type="number"
            size="4"
            [(ngModel)]="chart.maxPages">
      </clr-tree-node>
      <clr-tree-node class="form-group chart-md">
        <label class="chart-md" for="min-fontsize">Minimum chart font size</label>
        <input id="min-fontsize"
            class="chart-md boxchart"
            type="number"
            size="4"
            [(ngModel)]="chart.minFontsize">
      </clr-tree-node>
      <clr-tree-node class="form-group chart-md">
        <label class="chart-md" for="page-width">Page width</label>
        <input id="page-width"
            class="chart-md boxchart"
            type="number"
            size="4"
            min="0"
            step="any"
            [(ngModel)]="chart.pageWidth">
      </clr-tree-node>
      <clr-tree-node class="form-group chart-md">
        <label class="chart-md" for="page-width">Page height</label>
        <input id="page-width"
            class="chart-md boxchart"
            type="number"
            size="4"
            min="0"
            step="any"
            [(ngModel)]="chart.pageHeight">
      </clr-tree-node>
    </clr-tree-node>
    <clr-tree-node [clrTreeNodeExpanded]="expandChartData['dates']">
      Chart Dates
      <clr-tree-node class="chart-md">
        Chart created: {{ chart.createdAt | date:'medium' }}
      </clr-tree-node>
      <clr-tree-node class="chart-md">
        Chart updated: {{ chart.modifiedAt | date:'medium' }}
      </clr-tree-node>
    </clr-tree-node>
  </div>
  <!-- END: chart metadata tree -->
  </div>

<button class="btn btn-sm btn-primary-outline"
        (click)="addSection(0)">
  Add section here
</button>

  <!-- START: sections -->
  <div class="sections" *ngFor="let section of chart.sections;let sectionIndex=index">
    <div class="section">
      <!-- START: section dropdown -->
      <clr-dropdown class="section-dropdown" [clrMenuPosition]="'bottom-left'" [clrCloseMenuOnItemClick]="true">
        <button clrDropdownToggle>
          <clr-icon shape="settings" size="24"></clr-icon>
          <clr-icon shape="caret down"></clr-icon>
        </button>
        <clr-dropdown-menu>
          <span clrDropdownItem 
                class="info"
                (click)="addMeasureConfirm=true;sectIdx=sectionIndex">
            Add measures
          </span>
          <span clrDropdownItem
                class="warning"
                (click)="deleteMeasureConfirm=true;sectIdx=sectionIndex">
            Delete empty measures
          </span>
          <span clrDropdownItem
                class="danger danger-light"
                (click)="deleteConfirm=true;deleteType='section';delSectIdx=sectionIndex">
            Delete section
          </span>
        </clr-dropdown-menu>
      </clr-dropdown>
      <!-- END: section dropdown -->
      <!-- START: section metadata -->
      <div class="section-metadata">
        <input class="chart-md section-title" 
              type="text"
              size="64"
              placeholder="section title"
              [(ngModel)]="section.sectionName">
        <input class="chart-md section-desc" 
              type="text"
              size="64"
              placeholder="section description"
              [(ngModel)]="section.sectionDesc">
        <clr-tree-node [clrTreeNodeExpanded]="expandChartData['sectionData']">
          Section Data
          <clr-tree-node class="form-group chart-md">
            <label class="chart-md" for="measures-row">Measures per row</label>
            <input id="measures-row"
                class="chart-md boxchart"
                type="number"
                size="4"
                min="0"
                step="any"
                [(ngModel)]="section.measuresPerRow"
                (click)=organizeMeasures()>
          </clr-tree-node>
          <clr-tree-node class="form-group chart-md">
            <label class="chart-md" for="beats-meas">Beats per measure</label>
            <input id="beats-meas"
                class="chart-md boxchart"
                type="number"
                size="4"
                min="0"
                step="any"
                [(ngModel)]="section.beatsPerMeasure">
          </clr-tree-node>           
          <clr-tree-node class="form-group chart-md">
            <label class="chart-md" for="verse-count">Number of verses</label>
            <input id="verse-count"
                class="chart-md boxchart"
                type="number"
                size="4"
                min="0"
                step="any"
                [(ngModel)]="section.verseCount">
          </clr-tree-node>
        </clr-tree-node>
      </div>
      <!-- END: section metadata -->
      <!-- START: measures -->
      <table class="table table-compact">
      <tr *ngFor="let row of section.rows">
        <td *ngFor="let measure of row"
            (mouseenter)="measureCells[sectionIndex][measure.index]=true"
            (mouseleave)="measureCells[sectionIndex][measure.index]=false"
            class="measure">
          <!-- START: measure dropdown -->
          <div class="measure-dropdown">
            <clr-dropdown 
                *ngIf="measureCells[sectionIndex] && measureCells[sectionIndex][measure.index]"
                [clrMenuPosition]="'bottom-left'" 
                [clrCloseMenuOnItemClick]="true"
                class="measure-dropdown">
              <button clrDropdownToggle>
                <clr-icon shape="settings" size="18"></clr-icon>
                <clr-icon shape="caret down"></clr-icon>
              </button>
              <clr-dropdown-menu>
              <span clrDropdownItem 
                    class="info"
                    (click)="addMeasureBefore(sectionIndex, measure.index)">
                  Add measure before
                </span>
                <span clrDropdownItem
                      class="danger danger-light"
                      (click)="deleteConfirm=true;deleteType='measure';
                      delSectIdx=sectionIndex;delMeasIdx=measure.index">
                  Delete measure
                </span>
              </clr-dropdown-menu>
            </clr-dropdown>
          </div> 
          <!-- END: measure dropdown -->
          <!-- START: chords -->
          <table class="table table-compact">
            <tr>
              <!-- one chord box per beat -->
              <td class="chord" *ngFor="let j of section.beatsPerMeasure | fill">
                <input class="chord boxchart"
                        type="text" 
                        [(ngModel)]="measure.chords[j]" 
                        size="4" 
                        placeholder="/">
                </td>
              </tr>
            <!-- END: chords -->
            <!-- START: lyrics -->
              <tr *ngFor="let k of section.verseCount | fill">
                <td [attr.colspan]="section.beatsPerMeasure">
                  <input type="text" size="30" [(ngModel)]="measure.lyrics[k]">
                </td>
              </tr>
              <!-- END: lyrics -->
            </table>
          </td>
        </tr>
      <!-- END: measures -->
    </table>
  </div>
      <button class="btn btn-sm btn-primary-outline"
              (click)="addSection(sectionIndex + 1)">
        Add section here
      </button>
  <!-- END: sections -->
</div>

<!--**************************************************************************** -->
<!-- START: modals -->
<!--**************************************************************************** -->

<!-- Delete confirm modal -->
<clr-modal [(clrModalOpen)]="deleteConfirm">
  <h3 class="modal-title">Are you sure you want to delete this {{ deleteType }}?</h3>
  <div class="modal-body" [ngSwitch]="deleteType">
    <p *ngSwitchCase="'chart'" class="danger">
      This action cannot be undone.
    </p>
    <p *ngSwitchDefault>
      You may undo this change (along with all others since the last save) by reverting to the last saved version.
    </p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline" (click)="deleteConfirm = false">Cancel</button>
    <button type="button" class="btn btn-danger" (click)="deleteConfirm = false; deleteElement(deleteType, delSectIdx, delMeasIdx)">Delete</button>
  </div>
</clr-modal>
<!-- END: Delete confirm modal -->

<!-- Revert confirm modal -->
<clr-modal [(clrModalOpen)]="revertConfirm">
  <h3 class="modal-title">Are you sure you want to revert?</h3>
  <div class="modal-body">
    <p>If you revert to the last saved version, you will <span class="danger">lose all unsaved work</span>. This action cannot be undone.</p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline" (click)="revertConfirm = false">Cancel</button>
    <button type="button" class="btn btn-warning" (click)="revertConfirm = false; revertChart()">Revert</button>
  </div>
</clr-modal>
<!-- END: Revert confirm modal -->

<!-- Add measures modal -->
<clr-modal [(clrModalOpen)]="addMeasureConfirm">
  <h3 class="modal-title">Add Measures to Section</h3>
  <div class="modal-body">
    <label for="measure-count">Number of measures to add:</label>
        <input id="measure-count" type="number" #newMeasureCount>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline" (click)="addMeasureConfirm = false">Cancel</button>
    <button type="button" class="btn btn-warning" (click)="addMeasureConfirm = false; addMeasures(sectIdx, newMeasureCount.value)">Add</button>
  </div>
</clr-modal>
<!-- END: Add measures modal -->

<!-- Delete measures modal -->
<clr-modal [(clrModalOpen)]="deleteMeasureConfirm">
  <h3 class="modal-title">Are you sre?</h3>
  <div class="modal-body">
    Are you sure you want to delete the empty measures at the end of this section?
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline" (click)="deleteMeasureConfirm = false">Cancel</button>
    <button type="button" class="btn btn-warning" (click)="deleteMeasureConfirm = false; deleteEmptyMeasures(sectIdx)">Delete measures</button>
  </div>
</clr-modal>
<!-- END: Delete measures modal -->

<!--**************************************************************************** -->
<!-- END: modals -->
<!--**************************************************************************** -->
