<!--
  Copyright (c) 2017 Bonnie Schulkin. All Rights Reserved.

  This file is part of BoxCharter.

  BoxCharter is free software: you can redistribute it and/or modify it under
  the terms of the GNU Affero General Public License as published by the Free
  Software Foundation, either version 3 of the License, or (at your option)
  any later version.

  BoxCharter is distributed in the hope that it will be useful, but WITHOUT
  ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
  FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public License
  for more details.

  You should have received a copy of the GNU Affero General Public License
  along with BoxCharter. If not, see <http://www.gnu.org/licenses/>.
-->

<div *ngIf="chart" (click)="statusService.clearSuccess()">
  <div class="save-btn">
    <span class="btn btn-primary" (click)="saveChart()">Save</span>
  </div>
  <input id="chart-title"
        class="title boxchart" 
        type="text" 
        size="64"
        placeholder="chart title"
        [(ngModel)]="chart.title">
      
  <!-- START: header tree -->
  <clr-tree-node [clrTreeNodeExpanded]="true">
    Chart Authors
    <clr-tree-node class="form-group chart-md">
      <label class="chart-md chart-author" for="chart-composer">Music by</label>
      <input id="chart-composer"
          class="chart-md boxchart"
          type="text"
          size="48"
          placeholder="composer"
          [(ngModel)]="chart.composer">
    </clr-tree-node>
    <clr-tree-node class="form-group chart-md">
      <label class="chart-md chart-author" for="chart-lyricist">Lyrics by (</label>
      <input id="chart-lyricist-same" 
          type="checkbox" 
          [(ngModel)]="chart.lyricistSame">
        <label class="chart-md" for="chart-lyricist-same">Same as composer )</label>
      <span *ngIf="chart.lyricistSame == false">
        <input id="chart-lyricist"
            class="chart-md boxchart"
            type="text"
            size="48"
            placeholder="chart lyricist"
            [(ngModel)]="chart.lyricist">
      </span>
    </clr-tree-node>
    <clr-tree-node class="form-group chart-md">
      <label class="chart-md chart-author" for="chart-author">Chart by</label>
        <input id="chart-author"
          class="chart-md boxchart"
          type="text"
          size="48"
          placeholder="chart author"
          [(ngModel)]="chart.author">
    </clr-tree-node>
  </clr-tree-node>
  <clr-tree-node [clrTreeNodeExpanded]="true">
    Chart Keys
    <clr-tree-node class="form-group chart-md">
      <label class="chart-md" for="original-key">Original Key</label>
      <input id="original-key"
          class="chart-md boxchart"
          type="text"
          size="4"
          [(ngModel)]="chart.originalKey">
    </clr-tree-node>
    <clr-tree-node class="form-group chart-md">
      <label class="chart-md" for="transposed-key">Transposed Key</label>
      <input id="transposed-key"
          class="chart-md boxchart"
          type="text"
          size="4"
          [(ngModel)]="chart.printKey">
    </clr-tree-node>
  </clr-tree-node>
  <clr-tree-node [clrTreeNodeExpanded]="true">
    Chart PDF Options
    <clr-tree-node class="form-group chart-md">
      <label class="chart-md" for="max-pages">Maximum chart pages</label>
      <input id="max-pages"
          class="chart-md boxchart"
          type="number"
          size="4"
          [(ngModel)]="chart.maxPages">
    </clr-tree-node>
    <clr-tree-node class="form-group chart-md">
      <label class="chart-md" for="min-fontsize">Minimum chart font size</label>
      <input id="min-fontsize"
          class="chart-md boxchart"
          type="number"
          size="4"
          [(ngModel)]="chart.minFontsize">
    </clr-tree-node>
    <clr-tree-node class="form-group chart-md">
      <label class="chart-md" for="page-width">Page width</label>
      <input id="page-width"
          class="chart-md boxchart"
          type="number"
          size="4"
          min="0"
          step="any"
          [(ngModel)]="chart.pageWidth">
    </clr-tree-node>
    <clr-tree-node class="form-group chart-md">
      <label class="chart-md" for="page-width">Page height</label>
      <input id="page-width"
          class="chart-md boxchart"
          type="number"
          size="4"
          min="0"
          step="any"
          [(ngModel)]="chart.pageHeight">
    </clr-tree-node>
  </clr-tree-node>
  <clr-tree-node [clrTreeNodeExpanded]="true">
    Chart Dates
    <clr-tree-node class="chart-md">
      Chart created: {{ chart.createdAt | date:'medium' }}
    </clr-tree-node>
    <clr-tree-node class="chart-md">
      Chart updated: {{ chart.modifiedAt | date:'medium' }}
    </clr-tree-node>
  </clr-tree-node>
  <!-- END: header tree -->

  <!-- START: sections -->
  <div class="sections" *ngFor="let section of chart.sections;let section_index=index">
    <div class="section">
      <div class="section-headers">
        <!-- START: section metadata -->
        <div class="section-metadata section-header">
          <input class="chart-md section-title" 
                type="text"
                size="64"
                placeholder="section title"
                [(ngModel)]="section.sectionName">
          <input class="chart-md section-desc" 
                type="text"
                size="64"
                placeholder="section description"
                [(ngModel)]="section.sectionDesc">
          <clr-tree-node [clrTreeNodeExpanded]="true">
            Section Data
            <clr-tree-node class="form-group chart-md">
              <label class="chart-md" for="measures-row">Measures per row</label>
              <input id="measures-row"
                  class="chart-md boxchart"
                  type="number"
                  size="4"
                  min="0"
                  step="any"
                  [(ngModel)]="section.measuresPerRow"
                  (change)=redrawChart()>
            </clr-tree-node>
            <clr-tree-node class="form-group chart-md">
              <label class="chart-md" for="beats-meas">Beats per measure</label>
              <input id="beats-meas"
                  class="chart-md boxchart"
                  type="number"
                  size="4"
                  min="0"
                  step="any"
                  [(ngModel)]="section.beatsPerMeasure">
            </clr-tree-node>           
            <clr-tree-node class="form-group chart-md">
              <label class="chart-md" for="verse-count">Number of verses</label>
              <input id="verse-count"
                  class="chart-md boxchart"
                  type="number"
                  size="4"
                  min="0"
                  step="any"
                  [(ngModel)]="section.verseCount">
            </clr-tree-node>
          </clr-tree-node>
        </div>
        <!-- END: section metadata -->
        <!-- START: section buttons -->
        <div class="section-buttons section-header">
          <clr-dropdown [clrMenuPosition]="'bottom-left'" [clrCloseMenuOnItemClick]="true">
              <button class="btn btn-primary-outline" clrDropdownToggle>
                  <clr-icon shape="add" size="24"></clr-icon>
                  <clr-icon shape="caret down"></clr-icon>
              </button>
              <clr-dropdown-menu>
                  <a href="..." clrDropdownItem>Add section before</a>
                  <a href="..." clrDropdownItem>Add section after</a>
              </clr-dropdown-menu>
          </clr-dropdown>
          <button class="btn btn-danger-outline" (click)="deleteConfirm=true;deleteType='section';delSectIdx=sectionIndex">
            <clr-icon shape="remove"></clr-icon>
            <span class="clr-icon-title">
              Delete
            </span>
          </button>
        </div>
        <!-- END: section buttons -->
      </div>
      <!-- START: measures -->
      <table class="table table-compact">
      <ng-container *ngFor="let measure of section.measures; let i=index">
        <ng-container *ngIf="i % section.measuresPerRow == 0">
          <tr>
        </ng-container>
        <td class="measure">
          <!-- START: chords -->
          <table class="table table-compact">
            <tr>
              <!-- one chord box per beat -->
              <td class="chord" *ngFor="let j of section.beatsPerMeasure | fill">
                <input class="chord boxchart"
                        type="text" 
                        [(ngModel)]="measure.chords[j]" 
                        size="4" 
                        placeholder="/">
                </td>
              </tr>
            <!-- END: chords -->
            <!-- START: lyrics -->
              <tr *ngFor="let k of section.verseCount | fill">
                <td [attr.colspan]="section.beatsPerMeasure">
                  <input type="text" size="30" [(ngModel)]="measure.lyrics[k]">
                </td>
              </tr>
              <!-- END: lyrics -->
            </table>
          </td>
        <ng-container *ngIf="i % section.measuresPerRow == section.measuresPerRow">
          <tr>
        </ng-container>
      </ng-container>
      <!-- END: measures -->
    </table>
    </div>
  </div>
  <!-- END: sections -->
</div>

<!-- Delete section modal -->
<clr-modal [(clrModalOpen)]="deleteConfirm">
  <h3 class="modal-title">Are you sure you want to delete this {{ deleteType }}?</h3>
  <div class="modal-body">
    <p>This action cannot be undone.</p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-outline" (click)="deleteConfirm = false">Cancel</button>
    <button type="button" class="btn btn-primary" (click)="deleteConfirm = false; deleteElement(deleteType, delSectIdx, delMeasIdx)">Ok</button>
  </div>
</clr-modal>
<!-- END: Delete section modal -->